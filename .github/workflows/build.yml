name: Build VoltWise Central

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"

      - name: Install Dependencies
        run: |
          cd central-dashboard
          pip install -r requirements.txt

      - name: Build with PyInstaller (Windows)
        if: runner.os == 'Windows'
        run: |
          cd central-dashboard
          pyinstaller --name "VoltWise-Windows" --add-data "templates;templates" --add-data "static;static" --windowed --onefile app.py

      - name: Build with PyInstaller (Mac)
        if: runner.os == 'macOS'
        run: |
          cd central-dashboard
          # Create .app bundle (not onefile) for DMG
          pyinstaller --name "VoltWise" --add-data "templates:templates" --add-data "static:static" --windowed --noconsole app.py

      - name: Create DMG (Mac)
        if: runner.os == 'macOS'
        run: |
          cd central-dashboard
          brew install create-dmg
          # Create DMG with drag-drop link
          create-dmg \
            --volname "VoltWise Installer" \
            --window-pos 200 120 \
            --window-size 800 400 \
            --icon-size 100 \
            --app-drop-link 600 185 \
            "dist/VoltWise.dmg" \
            "dist/VoltWise.app"

      - name: Build with PyInstaller (Linux)
        if: runner.os == 'Linux'
        run: |
          cd central-dashboard
          pyinstaller --name "VoltWise-Linux" --add-data "templates:templates" --add-data "static:static" --windowed --onefile app.py

      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        if: github.ref == 'refs/heads/main'
        with:
          tag_name: latest
          name: Latest Build
          draft: false
          prerelease: false
          files: |
            central-dashboard/dist/VoltWise-Windows.exe
            central-dashboard/dist/VoltWise.dmg
            central-dashboard/dist/VoltWise-Linux
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: VoltWise-${{ runner.os }}
          path: central-dashboard/dist/*
