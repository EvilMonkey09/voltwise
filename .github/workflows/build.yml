name: Build and Release

on:
  push:
    branches: ["main"]

permissions:
  contents: write

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"

      - name: Install Dependencies
        run: |
          cd central-dashboard
          pip install -r requirements.txt
          cd ..
          pip install Pillow
          python generate_icons.py

      # --- Windows Build ---
      - name: Build Windows
        if: runner.os == 'Windows'
        run: |
          cd central-dashboard
          pyinstaller --name "VoltWise-Windows" --add-data "templates;templates" --add-data "static;static" --add-data "logo.png;." --icon "icon.ico" --windowed --onefile app.py

      # --- Linux Build ---
      - name: Build Linux
        if: runner.os == 'Linux'
        run: |
          cd central-dashboard
          pyinstaller --name "VoltWise-Linux" --add-data "templates:templates" --add-data "static:static" --add-data "logo.png:." --windowed --onefile app.py

      # --- Mac Build & DMG ---
      - name: Build Mac
        if: runner.os == 'macOS'
        run: |
          cd central-dashboard
          pyinstaller --name "VoltWise" --add-data "templates:templates" --add-data "static:static" --add-data "logo.png:." --icon "icon.icns" --console app.py
          brew install create-dmg
          # Cleanup old dmg if exists
          rm -f dist/VoltWise.dmg || true
          # Create DMG
          create-dmg \
            --volname "VoltWise Installer" \
            --window-pos 200 120 \
            --window-size 800 400 \
            --icon-size 100 \
            --app-drop-link 600 185 \
            "dist/VoltWise.dmg" \
            "dist/VoltWise.app"

      # --- Prepare for Upload (Normalize Paths) ---
      - name: Prepare Artifacts
        shell: bash
        run: |
          mkdir -p staging
          if [ "${{ runner.os }}" == "Windows" ]; then
            mv central-dashboard/dist/VoltWise-Windows.exe staging/
          elif [ "${{ runner.os }}" == "macOS" ]; then
            mv central-dashboard/dist/VoltWise.dmg staging/
          else
            mv central-dashboard/dist/VoltWise-Linux staging/
          fi

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: binary-${{ runner.os }}
          path: staging/*
          retention-days: 1

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - uses: actions/checkout@v3

      # Download all artifacts from previous jobs
      - name: Download Windows
        uses: actions/download-artifact@v4
        with:
          name: binary-Windows
          path: release_assets

      - name: Download macOS
        uses: actions/download-artifact@v4
        with:
          name: binary-macOS
          path: release_assets

      - name: Download Linux
        uses: actions/download-artifact@v4
        with:
          name: binary-Linux
          path: release_assets

      - name: Update Latest Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: latest
          name: Latest Release
          draft: false
          prerelease: false
          files: release_assets/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
